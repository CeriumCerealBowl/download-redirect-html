Write-Host "=======================================================================================" -ForegroundColor DarkYellow
Write-Host "CeriumNetworks.win Download/Installation Script - Cerium_696" -ForegroundColor Cyan
Write-Host "VERSION 1.2.4 | UPDATED 11/5/25" -ForegroundColor Magenta
Write-Host "=======================================================================================" -ForegroundColor DarkYellow

# --- CONFIG (Prompt for Drive Letter) ---
Write-Host "Enter the drive letter where the Setup directory should be created (e.g., C, D, E):" -ForegroundColor Cyan
$DriveInput = Read-Host
if (-not $DriveInput) {
    Write-Host "No input provided. Defaulting to C:" -ForegroundColor Yellow
    $Drive = "C:"
} else {
    if ($DriveInput -notmatch ":$") { $Drive = "${DriveInput}:" } else { $Drive = $DriveInput }
}

$BaseDir   = Join-Path $Drive "Setup"
$DepsDir   = Join-Path $BaseDir "Dependencies"
$MsDepsDir = Join-Path $DepsDir "Microsoft"

$dirs = @($BaseDir, $DepsDir, $MsDepsDir)
foreach ($dir in $dirs) { if (-not (Test-Path $dir)) { New-Item -Path $dir -ItemType Directory | Out-Null } }

# MAIN SOFTWARE LIST
$software = @(
    "Google.Chrome","Notepad++.Notepad++","Mozilla.Firefox","OBSProject.OBSStudio",
    "Discord.Discord","Nvidia.GeForceNow","StreetPea.chiaki-ng","Brave.Brave",
    "Google.ChromeRemoteDesktopHost","Valve.Steam","EpicGames.EpicGamesLauncher",
    "7zip.7zip","Parsec.Parsec","Proton.ProtonVPN","Guru3D.Afterburner",
    "Modrinth.ModrinthApp","Audacity.Audacity","Apple.iCloud","Apple.iTunes",
    "RARLab.WinRAR","NordSecurity.NordVPN","RileyTestut.AltServer"
)

# DEPENDENCIES LIST
$dependencies = @(
    "Microsoft.VCRedist.2013.x86","Microsoft.VCRedist.2013.x64","Microsoft.VCRedist.2010.x64",
    "Microsoft.VCRedist.2005.x86","Microsoft.VCRedist.2008.x86","Microsoft.VCRedist.2008.x64",
    "Microsoft.VCRedist.2005.x64","Microsoft.VCRedist.2015+.x86","Microsoft.VCRedist.2010.x86",
    "Microsoft.VCRedist.2012.x64","Microsoft.VCRedist.2012.x86","Microsoft.VCRedist.2015+.x64",
    "Microsoft.DotNet.DesktopRuntime.7","Microsoft.DotNet.DesktopRuntime.6",
    "Microsoft.DotNet.DesktopRuntime.5","Microsoft.DotNet.DesktopRuntime.3_1",
    "Amazon.Corretto.22.JDK"
)

function Download-List {
    param(
        [Parameter(Mandatory=$true)][string[]] $List,
        [Parameter(Mandatory=$true)][string] $DownloadPath,
        [Parameter()][string] $StageName = "Download"
    )

    if (-not (Test-Path $DownloadPath)) { New-Item -Path $DownloadPath -ItemType Directory | Out-Null }

    $total = $List.Count
    for ($i = 0; $i -lt $total; $i++) {
        $id = $List[$i]
        $percent = [int](($i/$total)*100)
        $current = $i + 1

        Write-Progress -Activity "$($StageName): $id" -Status "Item $current of $total" -PercentComplete $percent -Id 1
        try {
            if ($StageName -eq 'Dependencies') {
                winget download --id=$id --accept-package-agreements --accept-source-agreements --download-directory $DownloadPath 2>&1 | Out-Null
            } else {
                winget download --id=$id -e --accept-package-agreements --accept-source-agreements --download-directory $DownloadPath 2>&1 | Out-Null
            }
            Write-Host "$id - downloaded ($current/$total)" -ForegroundColor Green
        } catch {
            Write-Host "Failed to download $id : $_" -ForegroundColor Red
        }
    }
    Write-Progress -Activity "$($StageName)" -Completed -Id 1
}

function Install-InDirectory {
    param(
        [Parameter(Mandatory=$true)][string[]] $Folders
    )
    $files = Get-ChildItem -Path $Folders -Include *.exe,*.msi -Recurse -ErrorAction SilentlyContinue
    $total = $files.Count
    if ($total -eq 0) { Write-Host "No installer files found to install." -ForegroundColor Yellow; return }

    $i = 0
    foreach ($f in $files) {
        $i++
        $percent = [int](($i/$total)*100)
        Write-Progress -Activity "Installing" -Status "$($f.Name) ($i of $total)" -PercentComplete $percent -Id 2
        try {
            $ext = $f.Extension.ToLower()
            if ($ext -eq '.msi') {
                $args = "/i `"$($f.FullName)`" /qn /norestart"
                Start-Process -FilePath "msiexec.exe" -ArgumentList $args -Wait -NoNewWindow -ErrorAction SilentlyContinue
            } else {
                # Try common silent flags, fall back to running with no args
                $silentArgs = @('/S','/quiet','/silent','/qn')
                $installed = $false
                foreach ($sa in $silentArgs) {
                    try {
                        Start-Process -FilePath $f.FullName -ArgumentList $sa -Wait -NoNewWindow -ErrorAction SilentlyContinue
                        $installed = $true
                        break
                    } catch { }
                }
                if (-not $installed) {
                    Start-Process -FilePath $f.FullName -Wait -NoNewWindow -ErrorAction SilentlyContinue
                }
            }
            Write-Host "$($f.Name) - installed" -ForegroundColor Green
        } catch {
            Write-Host "Failed to install $($f.Name): $_" -ForegroundColor Red
        }
    }
    Write-Progress -Activity "Installing" -Completed -Id 2
}

# --- MENU (Console UI with progress) ---
Write-Host "" -ForegroundColor Cyan
Write-Host "Choose an action:" -ForegroundColor Cyan
Write-Host "1) Download Main Software"
Write-Host "2) Download Dependencies"
Write-Host "3) Download + Install Main Software"
Write-Host "4) Download + Install Dependencies"
Write-Host "5) Download EVERYTHING"
Write-Host "6) Download + Install EVERYTHING"
Write-Host "7) Exit"
$choice = Read-Host "Enter 1-7"

switch ($choice) {
    '1' {
        Download-List -List $software -DownloadPath $BaseDir -StageName 'Software'
    }
    '2' {
        $ms = $dependencies | Where-Object { $_ -notlike 'Amazon*' }
        $others = $dependencies | Where-Object { $_ -like 'Amazon*' }
        if ($ms.Count -gt 0) { Download-List -List $ms -DownloadPath $MsDepsDir -StageName 'Dependencies' }
        if ($others.Count -gt 0) { Download-List -List $others -DownloadPath $DepsDir -StageName 'Dependencies' }
    }
    '3' {
        Download-List -List $software -DownloadPath $BaseDir -StageName 'Software'
        Install-InDirectory -Folders @($BaseDir)
    }
    '4' {
        $ms = $dependencies | Where-Object { $_ -notlike 'Amazon*' }
        $others = $dependencies | Where-Object { $_ -like 'Amazon*' }
        if ($ms.Count -gt 0) { Download-List -List $ms -DownloadPath $MsDepsDir -StageName 'Dependencies' }
        if ($others.Count -gt 0) { Download-List -List $others -DownloadPath $DepsDir -StageName 'Dependencies' }
        Install-InDirectory -Folders @($MsDepsDir,$DepsDir)
    }
    '5' {
        Download-List -List $software -DownloadPath $BaseDir -StageName 'Software'
        $ms = $dependencies | Where-Object { $_ -notlike 'Amazon*' }
        $others = $dependencies | Where-Object { $_ -like 'Amazon*' }
        if ($ms.Count -gt 0) { Download-List -List $ms -DownloadPath $MsDepsDir -StageName 'Dependencies' }
        if ($others.Count -gt 0) { Download-List -List $others -DownloadPath $DepsDir -StageName 'Dependencies' }
    }
    '6' {
        Download-List -List $software -DownloadPath $BaseDir -StageName 'Software'
        $ms = $dependencies | Where-Object { $_ -notlike 'Amazon*' }
        $others = $dependencies | Where-Object { $_ -like 'Amazon*' }
        if ($ms.Count -gt 0) { Download-List -List $ms -DownloadPath $MsDepsDir -StageName 'Dependencies' }
        if ($others.Count -gt 0) { Download-List -List $others -DownloadPath $DepsDir -StageName 'Dependencies' }
        Install-InDirectory -Folders @($BaseDir,$MsDepsDir,$DepsDir)
    }
    default { Write-Host "Exiting." -ForegroundColor Yellow; exit }
}

Write-Host "=======================================================================================" -ForegroundColor DarkYellow
Write-Host "Task Complete - Files are in $BaseDir" -ForegroundColor Green
Write-Host "CeriumNetworks.win Script - Version 1.2.4 (11/5/25)" -ForegroundColor Cyan
Write-Host "=======================================================================================" -ForegroundColor DarkYellow
